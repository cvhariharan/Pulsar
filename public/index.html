<html>
  <head>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./styles.css">
  </head>

  <body onload="window.clientInit()" style="background-color: black;">
    <nav class="navigation black">
      <ul class="navigation__container">
        <a class="navigation__container-link-active" aria-current="page">
          <img class="navigation__container--logo" src="logo.png" alt="">
        </a>
      </ul>
    </nav>
    <button onclick="window.stopServer()">Stop</button><br />
    <!-- <video src="#" id="stream" width="852" height="480" class="center" type="video/mp4"></video>
    Video<br /> -->
    <div id="stream" class="video"></div> <br />
    <div id="logs" style="color: red;"></div>

    <script>
      var mimecode = 'video/mp4; codecs="avc1.42001f"';
      /* eslint-env browser */
      var keyboardMap = [
        "", // [0]
        "", // [1]
        "", // [2]
        "cancel", // [3]
        "", // [4]
        "", // [5]
        "help", // [6]
        "", // [7]
        "backspace", // [8]
        "tab", // [9]
        "", // [10]
        "", // [11]
        "clear", // [12]
        "enter", // [13]
        "enter_special", // [14]
        "", // [15]
        "shift", // [16]
        "ctrl", // [17]
        "alt", // [18]
        "pause", // [19]
        "caps_lock", // [20]
        "kana", // [21]
        "eisu", // [22]
        "junja", // [23]
        "final", // [24]
        "hanja", // [25]
        "", // [26]
        "esc", // [27]
        "convert", // [28]
        "nonconvert", // [29]
        "accept", // [30]
        "modechange", // [31]
        "space", // [32]
        "page_up", // [33]
        "page_down", // [34]
        "end", // [35]
        "home", // [36]
        "left", // [37]
        "up", // [38]
        "right", // [39]
        "down", // [40]
        "select", // [41]
        "print", // [42]
        "execute", // [43]
        "printscreen", // [44]
        "insert", // [45]
        "delete", // [46]
        "", // [47]
        "0", // [48]
        "1", // [49]
        "2", // [50]
        "3", // [51]
        "4", // [52]
        "5", // [53]
        "6", // [54]
        "7", // [55]
        "8", // [56]
        "9", // [57]
        "colon", // [58]
        "semicolon", // [59]
        "less_than", // [60]
        "equals", // [61]
        "greater_than", // [62]
        "question_mark", // [63]
        "at", // [64]
        "a", // [65]
        "b", // [66]
        "c", // [67]
        "d", // [68]
        "e", // [69]
        "f", // [70]
        "g", // [71]
        "h", // [72]
        "i", // [73]
        "j", // [74]
        "k", // [75]
        "l", // [76]
        "m", // [77]
        "n", // [78]
        "o", // [79]
        "p", // [80]
        "q", // [81]
        "r", // [82]
        "s", // [83]
        "t", // [84]
        "u", // [85]
        "v", // [86]
        "w", // [87]
        "x", // [88]
        "y", // [89]
        "z", // [90]
        "os_key", // [91] windows key (windows) or command key (mac)
        "", // [92]
        "context_menu", // [93]
        "", // [94]
        "sleep", // [95]
        "numpad0", // [96]
        "numpad1", // [97]
        "numpad2", // [98]
        "numpad3", // [99]
        "numpad4", // [100]
        "numpad5", // [101]
        "numpad6", // [102]
        "numpad7", // [103]
        "numpad8", // [104]
        "numpad9", // [105]
        "multiply", // [106]
        "add", // [107]
        "separator", // [108]
        "subtract", // [109]
        "decimal", // [110]
        "divide", // [111]
        "f1", // [112]
        "f2", // [113]
        "f3", // [114]
        "f4", // [115]
        "f5", // [116]
        "f6", // [117]
        "f7", // [118]
        "f8", // [119]
        "f9", // [120]
        "f10", // [121]
        "f11", // [122]
        "f12", // [123]
        "f13", // [124]
        "f14", // [125]
        "f15", // [126]
        "f16", // [127]
        "f17", // [128]
        "f18", // [129]
        "f19", // [130]
        "f20", // [131]
        "f21", // [132]
        "f22", // [133]
        "f23", // [134]
        "f24", // [135]
        "", // [136]
        "", // [137]
        "", // [138]
        "", // [139]
        "", // [140]
        "", // [141]
        "", // [142]
        "", // [143]
        "num_lock", // [144]
        "scroll_lock", // [145]
        "win_oem_fj_jisho", // [146]
        "win_oem_fj_masshou", // [147]
        "win_oem_fj_touroku", // [148]
        "win_oem_fj_loya", // [149]
        "win_oem_fj_roya", // [150]
        "", // [151]
        "", // [152]
        "", // [153]
        "", // [154]
        "", // [155]
        "", // [156]
        "", // [157]
        "", // [158]
        "", // [159]
        "circumflex", // [160]
        "exclamation", // [161]
        "double_quote", // [162]
        "hash", // [163]
        "dollar", // [164]
        "percent", // [165]
        "ampersand", // [166]
        "underscore", // [167]
        "open_paren", // [168]
        "close_paren", // [169]
        "asterisk", // [170]
        "plus", // [171]
        "pipe", // [172]
        "hyphen_minus", // [173]
        "open_curly_bracket", // [174]
        "close_curly_bracket", // [175]
        "tilde", // [176]
        "", // [177]
        "", // [178]
        "", // [179]
        "", // [180]
        "volume_mute", // [181]
        "volume_down", // [182]
        "volume_up", // [183]
        "", // [184]
        "", // [185]
        "semicolon", // [186]
        "equals", // [187]
        "comma", // [188]
        "minus", // [189]
        "period", // [190]
        "slash", // [191]
        "back_quote", // [192]
        "", // [193]
        "", // [194]
        "", // [195]
        "", // [196]
        "", // [197]
        "", // [198]
        "", // [199]
        "", // [200]
        "", // [201]
        "", // [202]
        "", // [203]
        "", // [204]
        "", // [205]
        "", // [206]
        "", // [207]
        "", // [208]
        "", // [209]
        "", // [210]
        "", // [211]
        "", // [212]
        "", // [213]
        "", // [214]
        "", // [215]
        "", // [216]
        "", // [217]
        "", // [218]
        "open_bracket", // [219]
        "back_slash", // [220]
        "close_bracket", // [221]
        "quote", // [222]
        "", // [223]
        "meta", // [224]
        "altgr", // [225]
        "", // [226]
        "win_ico_help", // [227]
        "win_ico_00", // [228]
        "", // [229]
        "win_ico_clear", // [230]
        "", // [231]
        "", // [232]
        "win_oem_reset", // [233]
        "win_oem_jump", // [234]
        "win_oem_pa1", // [235]
        "win_oem_pa2", // [236]
        "win_oem_pa3", // [237]
        "win_oem_wsctrl", // [238]
        "win_oem_cusel", // [239]
        "win_oem_attn", // [240]
        "win_oem_finish", // [241]
        "win_oem_copy", // [242]
        "win_oem_auto", // [243]
        "win_oem_enlw", // [244]
        "win_oem_backtab", // [245]
        "attn", // [246]
        "crsel", // [247]
        "exsel", // [248]
        "ereof", // [249]
        "play", // [250]
        "zoom", // [251]
        "", // [252]
        "pa1", // [253]
        "win_oem_clear", // [254]
        "" // [255]
      ];
      var streamDiv = document.getElementById("stream");

      var http = new XMLHttpRequest();
      var url = 'http://34.93.147.116:7000';

      var localSd;
      var remoteSd;
      var serverId;

      let clientId = makeid(5);
      var ICE_config = {
        iceServers: [
          {
            url: "stun:stun.l.google.com:19302"
          }
          // {
          //   url: "turn:server-ip",
          //   credential: "password",
          //   username: "user"
          // }
        ]
      };
      function makeid(length) {
        var result = "";
        var characters =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        var charactersLength = characters.length;
        for (var i = 0; i < length; i++) {
          result += characters.charAt(
            Math.floor(Math.random() * charactersLength)
          );
        }
        return result;
      }
      pc = new RTCPeerConnection(ICE_config);
      let log = msg => {
        document.getElementById("logs").innerHTML += msg + "<br>";
      };
      const dataChannelOptions = {
        maxPacketLifeTime: 200
      };
      pc.addTransceiver('video', {'direction': 'sendrecv'})
      pc.ontrack = function (event) {
        var el = document.createElement(event.track.kind)
        el.srcObject = event.streams[0]
        el.autoplay = true
        el.controls = false
        document.getElementById('stream').appendChild(el)
      }
      let sendChannel = pc.createDataChannel("foo", dataChannelOptions);
      sendChannel.onclose = () => console.log("sendChannel has closed");
      sendChannel.onopen = () => console.log("sendChannel has opened");
      let clickChannel = pc.createDataChannel("click");
      clickChannel.onclose = () => console.log("clickChannel closed");
      clickChannel.onopen = () => console.log("clickChannel open");
      let keyChannel = pc.createDataChannel("key");
      keyChannel.onclose = () => console.log("keyChannel closed");
      keyChannel.onopen = () => console.log("keyChannel open");
      $("#stream").mousedown(function(event) {
        console.log(event.clientX + "," + event.clientY);
        if (event.which == 1) {
          console.log("left down");
          clickChannel.send("ld");
        } else if (event.which == 3) {
          console.log("right down");
          clickChannel.send("rd");
        }
      });
      $("#stream").mouseup(function(event) {
        console.log(event.clientX + "," + event.clientY);
        if (event.which == 1) {
          console.log("lu");
          clickChannel.send("lu");
        } else if (event.which == 3) {
          console.log("ru");
          clickChannel.send("ru");
        }
      });
      $("#stream").mousemove(function(event) {
        var relX = event.pageX - $(this).offset().left;
        var relY = event.pageY - $(this).offset().top;
        var relBoxCoords = relX + "," + relY;
        // console.log(relBoxCoords)
        sendChannel.send(relBoxCoords);
      });
      document.onkeydown = function(e) {
        get = window.event ? event : e;
        key = get.keyCode ? get.keyCode : get.charCode;
        keyChannel.send(keyboardMap[get.keyCode]);
        console.log(keyboardMap[get.keyCode]);
      };
      
      pc.oniceconnectionstatechange = e => log(pc.iceConnectionState);
      pc.onicecandidate = event => {
        if (event.candidate === null) {
          localSd = btoa(
            JSON.stringify(pc.localDescription)
          );
        }
      };
      pc.onnegotiationneeded = e =>
        pc
          .createOffer()
          .then(d => pc.setLocalDescription(d))
          .catch(log);
      window.clientInit = () => {
        console.log("clientInit()")
        // var params = 'username=hariharan&game=Quake';
        // http.open('POST', url + "/create", true);
        // //Send the proper header information along with the request
        // http.setRequestHeader('Content-type', 'multipart/form-data');

        // http.onreadystatechange = function() {//Call a function when the state changes.
        //   if(http.readyState == 4 && http.status == 200) {
        //     console.log(http.responseText);
        //     serverId = http.responseText;
        //     // Signal the server with init info from client
        //     let ws = new WebSocket("ws://34.93.147.116:9000/client"); //WebSocket("ws://35.204.44.44:9000/client");
        //     ws.onopen = function(e) {
        //       clientMsg = {
        //         id: clientId,
        //         serverid: serverId,
        //         sdp: localSd
        //       };
        //       console.log(clientMsg)
        //       ws.send(JSON.stringify(clientMsg));
        //     };
        //     ws.onmessage = function(e) {
        //       console.log(e.data);
        //       remoteSd = e.data;
        //       window.startSession();
        //       var formDiv = document.getElementById("formDiv");
        //       formDiv.style.display = "none";
        //       console.log("Connected");
        //     };
        //   }else{console.log(http.responseText)}
        // };
        // http.send(params);
      }

      window.stopServer = () =>{
        http.open('GET', url + "/stop?id=" + serverId, true);

        http.onreadystatechange = function() {//Call a function when the state changes.
          if(http.readyState == 4 && http.status == 200) {
             alert("Deleted")
          }else{console.log(http.responseText)}
        }
        http.send();
      };

      window.sendMessage = () => {
        let message = document.getElementById("message").value;
        if (message === "") {
          return alert("Message must not be empty");
        }
        sendChannel.send(message);
      };
      window.startSession = () => {
        let sd = remoteSd;
        if (sd === "") {
          return alert("Session Description must not be empty");
        }
        try {
          pc.setRemoteDescription(
            new RTCSessionDescription(JSON.parse(atob(sd)))
          );
        } catch (e) {
          alert(e);
        }
      };
    </script>
  </body>
</html>

