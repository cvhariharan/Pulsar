<html>

<head>
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
</head>

<body>
  <div id="formDiv">
    Browser base64 Session Description <textarea id="localSessionDescription" readonly="true"></textarea> <br />
    Golang base64 Session Description: <textarea id="remoteSessionDescription"></textarea> <br />
    <button onclick="window.startSession()"> Start Session </button> <br />
    <br />
    Server ID: <textarea id="serverid"></textarea> <br />
    <button onclick="window.clientInit()">Client Init</button>
    Message: <textarea id="message">This is my DataChannel message!</textarea> <br />
    <button onclick="window.sendMessage()"> Send Message </button> <br />
  </div>
  <img src="#" id="stream" width="640" height="480">
  <div id="logs"></div>

  <script>
    /* eslint-env browser */
    function makeid(length) {
      var result = '';
      var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var charactersLength = characters.length;
      for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
      }
      return result;
    }
    let clientId = makeid(5)
    var ICE_config= {
    'iceServers': [
      {
        'url': 'stun:stun.l.google.com:19302'
      },
      {
        'url': 'turn:34.93.71.20',
        'credential': 'password',
        'username': 'user'
      }
    ]
  }
pc = new RTCPeerConnection(ICE_config);

    // let pc = new RTCPeerConnection({
    //   iceServers: [
    //     {
    //       urls: 'stun:stun.l.google.com:19302'
    //     }
    //   ]
    // })
    let log = msg => {
      document.getElementById('logs').innerHTML += msg + '<br>'
    }

    let sendChannel = pc.createDataChannel('foo')
    sendChannel.onclose = () => console.log('sendChannel has closed')
    sendChannel.onopen = () => console.log('sendChannel has opened')
    sendChannel.onmessage = e => {
      console.log(e.data)
      var imageUrl = URL.createObjectURL(e.data);
      var img = document.querySelector("#stream");
      img.src = imageUrl;
    }

    let clickChannel = pc.createDataChannel('click')
    clickChannel.onclose = () => console.log('clickChannel closed')
    clickChannel.onopen = () => console.log('clickChannel open')

    let keyChannel = pc.createDataChannel('key')
    keyChannel.onclose = () => console.log('keyChannel closed')
    keyChannel.onopen = () => console.log('keyChannel open')
    
    $("#stream").mousedown(function(event) {
      console.log(event.clientX + "," + event.clientY)
      if(event.which == 1) {
        console.log("left down")
        clickChannel.send("ld")
      } else if(event.which == 3) {
        console.log("right down")
        clickChannel.send("rd")
      }
    })
    $("#stream").mouseup(function(event) {
      console.log(event.clientX + "," + event.clientY)
      if(event.which == 1) {
        console.log("lu")
        clickChannel.send("lu")
      } else if(event.which == 3) {
        console.log("ru")
        clickChannel.send("ru")
      }
    })
//     $("#stream").mousedown(function(ev){
//       if(ev.which == 3)
//       {
//            console.log("right")
//       }
// })   

    $("#stream").mousemove(function(event){            
        var relX = event.pageX - $(this).offset().left
        var relY = event.pageY - $(this).offset().top
        var relBoxCoords = relX + "," + relY
        // console.log(relBoxCoords)
        sendChannel.send(relBoxCoords)
    })


    document.onkeypress = function(e) {
      get = window.event?event:e;
      key = get.keyCode?get.keyCode:get.charCode;
      key = String.fromCharCode(key);
      console.log(key)
      keyChannel.send(key)
    }

    pc.oniceconnectionstatechange = e => log(pc.iceConnectionState)
    pc.onicecandidate = event => {
      if (event.candidate === null) {
        document.getElementById('localSessionDescription').value = btoa(JSON.stringify(pc.localDescription))
      }
    }

    pc.onnegotiationneeded = e =>
      pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log)

    window.clientInit = () => {
      // Signal the server with init info from client
      let ws = new WebSocket("ws://34.93.71.20:9000/client")
      ws.onopen = function (e) {
        clientMsg = {
          id: clientId,
          serverid: document.getElementById("serverid").value,
          sdp: document.getElementById("localSessionDescription").value
        }
        ws.send(JSON.stringify(clientMsg))
      }
      ws.onmessage = function (e) {
        console.log(e.data)
        document.getElementById("remoteSessionDescription").value = e.data
        window.startSession()
        var formDiv = document.getElementById("formDiv")
        formDiv.style.display = "none"
        console.log("Connected")
      }
    }

    window.sendMessage = () => {
      let message = document.getElementById('message').value
      if (message === '') {
        return alert('Message must not be empty')
      }

      sendChannel.send(message)
    }

    window.startSession = () => {
      let sd = document.getElementById('remoteSessionDescription').value
      if (sd === '') {
        return alert('Session Description must not be empty')
      }

      try {
        pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(atob(sd))))
      } catch (e) {
        alert(e)
      }
    }

  </script>
</body>

</html>